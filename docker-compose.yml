services:
 db:
  image: mysql:8.0
  environment:
   MYSQL_ROOT_PASSWORD: root_password
   MYSQL_DATABASE: cie_v232
   MYSQL_USER: cie_user
   MYSQL_PASSWORD: cie_password
  volumes:
   - db_data:/var/lib/mysql
   - ./database/migrations:/docker-entrypoint-initdb.d
  ports:
   - "3307:3306"
 
 redis:
  image: redis:7-alpine
  ports:
   - "6379:6379"
  volumes:
   - redis_data:/data
 
 php-api:
  build:
   context: ./backend/php
   dockerfile: ../../infrastructure/docker/Dockerfile.php
  volumes:
   - ./backend/php:/app
   - ./storage:/app/storage
  environment:
   - DB_HOST=db
   - DB_PORT=3306
   - DB_DATABASE=cie_v232
   - DB_USERNAME=cie_user
   - DB_PASSWORD=cie_password
   - REDIS_URL=redis://redis:6379/0
   - PYTHON_API_URL=http://python-worker:8000
   - APP_NAME=CIE
   - APP_ENV=local
   - APP_DEBUG=true
  depends_on:
   - db
   - redis
  ports:
   - "8080:8000"

 python-worker:
  build:
   context: ./backend/python
   dockerfile: ../../infrastructure/docker/Dockerfile.python
  volumes:
   - ./backend/python:/app
  environment:
   - DB_HOST=db
   - DB_PORT=3306
   - DB_DATABASE=cie_v232
   - DB_USERNAME=cie_user
   - DB_PASSWORD=cie_password
   - REDIS_URL=redis://redis:6379/0
   - OPENAI_API_KEY=${OPENAI_API_KEY}
   - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
   - PORT=8000
  depends_on:
   - db
   - redis
  ports:
   - "8000:8000"
 
 nginx:
  image: nginx:alpine
  volumes:
   - ./infrastructure/docker/nginx.conf:/etc/nginx/nginx.conf
   - ./frontend/dist:/usr/share/nginx/html
  ports:
   - "8081:80"
  depends_on:
   - php-api

volumes:
 db_data:
 redis_data:
